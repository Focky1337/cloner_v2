{% extends "base.html" %}

{% block title %}Админ панель - MegaCloner{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <div>
            <h1><i class="fas fa-shield-alt"></i> Админ панель</h1>
            <p>Управление клиентами и зеркалами</p>
        </div>
    </div>

    <!-- Статистика -->
    <div class="stats-grid" id="adminStats">
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-users"></i>
            </div>
            <div>
                <div class="stat-value" id="totalClients">-</div>
                <div class="stat-label">Всего клиентов</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-copy"></i>
            </div>
            <div>
                <div class="stat-value" id="totalMirrors">-</div>
                <div class="stat-label">Всего зеркал</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div>
                <div class="stat-value" id="activeMirrors">-</div>
                <div class="stat-label">Активных зеркал</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div>
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">Общий доход</div>
            </div>
        </div>
    </div>

    <!-- Список клиентов -->
    <div class="dashboard-section">
        <h2><i class="fas fa-users"></i> Клиенты</h2>
        <div class="accounts-table-container">
            <table class="accounts-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Имя</th>
                        <th>URL</th>
                        <th>Зеркал</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="clientsTable">
                    <tr>
                        <td colspan="7" class="loading">Загрузка...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Список зеркал -->
    <div class="dashboard-section">
        <h2><i class="fas fa-copy"></i> Зеркала</h2>
        <div class="accounts-table-container">
            <table class="accounts-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Клиент</th>
                        <th>Название</th>
                        <th>Статус</th>
                        <th>Оплата</th>
                        <th>Создано</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="mirrorsTable">
                    <tr>
                        <td colspan="7" class="loading">Загрузка...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Загрузка статистики
async function loadAdminStats() {
    try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        document.getElementById('totalClients').textContent = data.total_clients || 0;
        document.getElementById('totalMirrors').textContent = data.total_mirrors || 0;
        document.getElementById('activeMirrors').textContent = data.active_mirrors || 0;
        document.getElementById('totalRevenue').textContent = '$' + (data.total_revenue || 0);
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
    }
}

// Загрузка клиентов
async function loadClients() {
    try {
        const response = await fetch('/api/admin/clients');
        const data = await response.json();
        
        const tbody = document.getElementById('clientsTable');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty">Нет клиентов</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.map(client => `
            <tr>
                <td>${client.user_id}</td>
                <td>@${client.username || 'без_username'}</td>
                <td>${client.first_name || '-'}</td>
                <td><a href="/${client.web_url}/dashboard" target="_blank">/${client.web_url}</a></td>
                <td>${client.mirrors_count || 0}</td>
                <td><span class="badge badge-success">Активен</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="viewClient(${client.user_id})">
                        <i class="fas fa-eye"></i> Просмотр
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Ошибка загрузки клиентов:', error);
        document.getElementById('clientsTable').innerHTML = 
            '<tr><td colspan="7" class="error">Ошибка загрузки данных</td></tr>';
    }
}

// Загрузка зеркал
async function loadMirrors() {
    try {
        const response = await fetch('/api/admin/mirrors');
        const data = await response.json();
        
        const tbody = document.getElementById('mirrorsTable');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty">Нет зеркал</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.map(mirror => `
            <tr>
                <td>${mirror.id}</td>
                <td>@${mirror.username || 'без_username'}</td>
                <td>${mirror.mirror_name}</td>
                <td>
                    <span class="badge ${mirror.status === 'active' ? 'badge-success' : 'badge-secondary'}">
                        ${mirror.status === 'active' ? 'Активно' : 'Ожидание'}
                    </span>
                </td>
                <td>
                    <span class="badge ${mirror.payment_status === 'paid' ? 'badge-success' : 'badge-secondary'}">
                        ${mirror.payment_status === 'paid' ? 'Оплачено' : 'Не оплачено'}
                    </span>
                </td>
                <td>${mirror.created_at || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="viewMirror(${mirror.id})">
                        <i class="fas fa-eye"></i> Просмотр
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Ошибка загрузки зеркал:', error);
        document.getElementById('mirrorsTable').innerHTML = 
            '<tr><td colspan="7" class="error">Ошибка загрузки данных</td></tr>';
    }
}

function viewClient(userId) {
    // TODO: Реализовать просмотр деталей клиента
    alert('Просмотр клиента: ' + userId);
}

function viewMirror(mirrorId) {
    // TODO: Реализовать просмотр деталей зеркала
    alert('Просмотр зеркала: ' + mirrorId);
}

// Загружаем данные при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    loadAdminStats();
    loadClients();
    loadMirrors();
    
    // Обновляем каждые 30 секунд
    setInterval(() => {
        loadAdminStats();
        loadClients();
        loadMirrors();
    }, 30000);
});
</script>
{% endblock %}

