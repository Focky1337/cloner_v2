{% extends "base.html" %}

{% block title %}–ê–∫–∫–∞—É–Ω—Ç—ã - MegaCloner{% endblock %}

{% block content %}
<div class="accounts-page">
    <div class="page-header">
        <h1><i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</h1>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="showAddAccountModal()">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
            </button>
            <button class="btn btn-primary" onclick="refreshAccounts()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button class="btn btn-secondary" onclick="showBulkActions()">
                <i class="fas fa-tasks"></i> –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
            </button>
        </div>
    </div>

    <div class="accounts-filters">
        <input type="text" id="searchInput" class="cyber-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." onkeyup="filterAccounts()">
        <select id="statusFilter" class="cyber-input" onchange="filterAccounts()">
            <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
        </select>
    </div>

    <div class="accounts-table-container">
        <table class="accounts-table" id="accountsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü—Ä–æ–∫—Å–∏</th>
                    <th>–ü–æ–ª</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="accountsTableBody">
                <tr>
                    <td colspan="8" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
            <span class="close" onclick="closeModal('editModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" id="editPhone" class="cyber-input" readonly>
            </div>
            <div class="form-group">
                <label>–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                <input type="text" id="editSource" class="cyber-input" placeholder="@source_chat">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="editDest" class="cyber-input" placeholder="@chat1, @chat2">
            </div>
            <div class="form-group">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <label class="cyber-switch">
                    <input type="checkbox" id="editStatus">
                    <span class="slider"></span>
                </label>
                <span id="statusText">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
            </div>
            <div class="form-group">
                <label>–ü–æ–ª</label>
                <select id="editGender" class="cyber-input">
                    <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveAccount()">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="btn btn-secondary" onclick="closeModal('editModal')">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
<div id="addAccountModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
            <span class="close" onclick="closeAddAccountModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ -->
            <div id="addAccountStep1" class="add-account-step">
                <div class="form-group">
                    <label>–°–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</label>
                    <div class="add-method-buttons">
                        <button class="btn btn-primary btn-block" onclick="showPhoneAuth()">
                            <i class="fas fa-phone"></i> –ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="showSessionUpload()">
                            <i class="fas fa-file-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å .session —Ñ–∞–π–ª
                        </button>
                    </div>
                </div>
            </div>

            <!-- –®–∞–≥ 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É -->
            <div id="addAccountStep2" class="add-account-step" style="display: none;">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" id="addPhone" class="cyber-input" placeholder="+1234567890" onkeypress="if(event.key==='Enter') sendAuthCode()">
                </div>
                <div class="form-group" id="codeGroup" style="display: none;">
                    <label>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
                    <input type="text" id="addCode" class="cyber-input" placeholder="12345" maxlength="5" onkeypress="if(event.key==='Enter') verifyAuthCode()">
                </div>
                <div class="form-group" id="password2FAGroup" style="display: none;">
                    <label>–ü–∞—Ä–æ–ª—å 2FA</label>
                    <input type="password" id="addPassword2FA" class="cyber-input" placeholder="–ü–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏" onkeypress="if(event.key==='Enter') verify2FA()">
                </div>
                <div class="form-group" id="accountSettingsGroup" style="display: none;">
                    <label>–ò—Å—Ç–æ—á–Ω–∏–∫ (—á–∞—Ç/–∫–∞–Ω–∞–ª)</label>
                    <input type="text" id="addSource" class="cyber-input" placeholder="@source_chat –∏–ª–∏ ID">
                </div>
                <div class="form-group" id="accountDestGroup" style="display: none;">
                    <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="addDest" class="cyber-input" placeholder="@chat1, @chat2">
                </div>
                <div class="form-group" id="accountGenderGroup" style="display: none;">
                    <label>–ü–æ–ª</label>
                    <select id="addGender" class="cyber-input">
                        <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                    </select>
                </div>
            </div>

            <!-- –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ .session —Ñ–∞–π–ª–∞ -->
            <div id="addAccountStep3" class="add-account-step" style="display: none;">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ .session —Ñ–∞–π–ª</label>
                    <div class="file-upload-area" id="sessionUploadArea" style="min-height: 150px;">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .session —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏</p>
                        <label for="sessionFileInput" class="btn btn-secondary btn-sm">
                            <i class="fas fa-folder-open"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </label>
                        <input type="file" id="sessionFileInput" style="display: none;" accept=".session" onchange="handleSessionFileSelect(event)">
                        <p class="file-name" id="selectedSessionFileName"></p>
                    </div>
                </div>
                <div class="form-group" id="sessionSettingsGroup" style="display: none;">
                    <label>–ò—Å—Ç–æ—á–Ω–∏–∫ (—á–∞—Ç/–∫–∞–Ω–∞–ª)</label>
                    <input type="text" id="sessionSource" class="cyber-input" placeholder="@source_chat –∏–ª–∏ ID">
                </div>
                <div class="form-group" id="sessionDestGroup" style="display: none;">
                    <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="sessionDest" class="cyber-input" placeholder="@chat1, @chat2">
                </div>
                <div class="form-group" id="sessionGenderGroup" style="display: none;">
                    <label>–ü–æ–ª</label>
                    <select id="sessionGender" class="cyber-input">
                        <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="sendCodeBtn" onclick="sendAuthCode()" style="display: none;">
                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
            </button>
            <button class="btn btn-primary" id="verifyCodeBtn" onclick="verifyAuthCode()" style="display: none;">
                <i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥
            </button>
            <button class="btn btn-primary" id="verify2FABtn" onclick="verify2FA()" style="display: none;">
                <i class="fas fa-shield-alt"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å 2FA
            </button>
            <button class="btn btn-primary" id="saveAccountBtn" onclick="saveNewAccount()" style="display: none;">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <button class="btn btn-primary" id="uploadSessionBtn" onclick="uploadSessionFile()" style="display: none;">
                <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å .session
            </button>
            <button class="btn btn-secondary" onclick="closeAddAccountModal()">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allAccounts = [];
    let currentEditPhone = null;

    async function loadAccounts() {
        const tbody = document.getElementById('accountsTableBody');
        tbody.innerHTML = '<tr><td colspan="8" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        
        try {
            const response = await fetch('/api/accounts');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                if (response.status === 401 || response.status === 403) {
                    tbody.innerHTML = `<tr><td colspan="8" class="error">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.</td></tr>`;
                    return;
                }
                const text = await response.text();
                tbody.innerHTML = `<tr><td colspan="8" class="error">–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞</td></tr>`;
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }
            
            const allAccounts = await response.json();
            
            if (allAccounts.error) {
                tbody.innerHTML = `<tr><td colspan="8" class="error">${allAccounts.error}</td></tr>`;
                return;
            }
            
            displayAccounts(allAccounts);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="8" class="error">–û—à–∏–±–∫–∞: ${error.message}</td></tr>`;
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', error);
        }
    }

    function displayAccounts(accounts) {
        const tbody = document.getElementById('accountsTableBody');
        
        if (accounts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤</td></tr>';
            return;
        }
        
        tbody.innerHTML = accounts.map(acc => `
            <tr data-phone="${acc.phone}">
                <td><input type="checkbox" class="account-checkbox" value="${acc.phone}"></td>
                <td><strong>${acc.phone}</strong></td>
                <td>${acc.source_chat}</td>
                <td>${acc.dest_chats.length} —á–∞—Ç(–æ–≤)</td>
                <td>
                    <span class="badge ${acc.copy_mode === '–ê–∫—Ç–∏–≤–µ–Ω' ? 'badge-success' : 'badge-secondary'}">
                        ${acc.copy_mode}
                    </span>
                </td>
                <td>${acc.proxy_id}</td>
                <td>${acc.gender === 'female' ? 'üë©' : 'üë®'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editAccount('${acc.phone}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAccount('${acc.phone}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function filterAccounts() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        
        let filtered = allAccounts.filter(acc => {
            const matchSearch = acc.phone.toLowerCase().includes(search);
            const matchStatus = status === 'all' || 
                (status === 'active' && acc.copy_mode === '–ê–∫—Ç–∏–≤–µ–Ω') ||
                (status === 'inactive' && acc.copy_mode !== '–ê–∫—Ç–∏–≤–µ–Ω');
            return matchSearch && matchStatus;
        });
        
        displayAccounts(filtered);
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.account-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
    }

    function refreshAccounts() {
        loadAccounts();
    }

    function editAccount(phone) {
        const account = allAccounts.find(acc => acc.phone === phone);
        if (!account) return;
        
        currentEditPhone = phone;
        document.getElementById('editPhone').value = account.phone;
        document.getElementById('editSource').value = account.source_chat !== '–ù–µ —É–∫–∞–∑–∞–Ω' ? account.source_chat : '';
        document.getElementById('editDest').value = account.dest_chats.join(', ');
        document.getElementById('editStatus').checked = account.copy_mode === '–ê–∫—Ç–∏–≤–µ–Ω';
        document.getElementById('editGender').value = account.gender;
        updateStatusText();
        
        document.getElementById('editModal').style.display = 'block';
    }

    document.getElementById('editStatus').addEventListener('change', updateStatusText);
    function updateStatusText() {
        const text = document.getElementById('statusText');
        text.textContent = document.getElementById('editStatus').checked ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
        text.style.color = document.getElementById('editStatus').checked ? '#00ff88' : '#a0a0a0';
    }

    async function saveAccount() {
        const data = {
            phone: currentEditPhone,
            source_chat: document.getElementById('editSource').value,
            dest_chats: document.getElementById('editDest').value.split(',').map(s => s.trim()).filter(s => s),
            copy_mode: document.getElementById('editStatus').checked ? 1 : 0,
            gender: document.getElementById('editGender').value
        };

        try {
            const response = await fetch('/api/accounts/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                showNotification('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                closeModal('editModal');
                loadAccounts();
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    async function deleteAccount(phone) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç ${phone}?`)) return;
        
        try {
            const response = await fetch(`/api/accounts/delete/${encodeURIComponent(phone)}`, {
                method: 'DELETE'
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                showNotification('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω!', 'success');
                loadAccounts();
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    let currentAuthStep = 1;
    let currentAuthPhone = null;
    let currentAuthCodeHash = null;

    function showAddAccountModal() {
        currentAuthStep = 1;
        currentAuthPhone = null;
        currentAuthCodeHash = null;
        
        // –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª–µ–π
        document.getElementById('addPhone').value = '';
        document.getElementById('addCode').value = '';
        document.getElementById('addPassword2FA').value = '';
        document.getElementById('addSource').value = '';
        document.getElementById('addDest').value = '';
        document.getElementById('addGender').value = 'male';
        document.getElementById('sessionFileInput').value = '';
        document.getElementById('selectedSessionFileName').textContent = '';
        document.getElementById('sessionSource').value = '';
        document.getElementById('sessionDest').value = '';
        document.getElementById('sessionGender').value = 'male';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —à–∞–≥ 1
        document.getElementById('addAccountStep1').style.display = 'block';
        document.getElementById('addAccountStep2').style.display = 'none';
        document.getElementById('addAccountStep3').style.display = 'none';
        
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏
        document.getElementById('sendCodeBtn').style.display = 'none';
        document.getElementById('verifyCodeBtn').style.display = 'none';
        document.getElementById('verify2FABtn').style.display = 'none';
        document.getElementById('saveAccountBtn').style.display = 'none';
        document.getElementById('uploadSessionBtn').style.display = 'none';
        
        // –°–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—ã
        document.getElementById('codeGroup').style.display = 'none';
        document.getElementById('password2FAGroup').style.display = 'none';
        document.getElementById('accountSettingsGroup').style.display = 'none';
        document.getElementById('accountDestGroup').style.display = 'none';
        document.getElementById('accountGenderGroup').style.display = 'none';
        document.getElementById('sessionSettingsGroup').style.display = 'none';
        document.getElementById('sessionDestGroup').style.display = 'none';
        document.getElementById('sessionGenderGroup').style.display = 'none';
        
        document.getElementById('addAccountModal').style.display = 'block';
    }

    function showPhoneAuth() {
        document.getElementById('addAccountStep1').style.display = 'none';
        document.getElementById('addAccountStep2').style.display = 'block';
        document.getElementById('sendCodeBtn').style.display = 'inline-flex';
    }

    function showSessionUpload() {
        document.getElementById('addAccountStep1').style.display = 'none';
        document.getElementById('addAccountStep3').style.display = 'block';
        document.getElementById('uploadSessionBtn').style.display = 'inline-flex';
    }

    async function sendAuthCode() {
        const phone = document.getElementById('addPhone').value.trim();
        if (!phone) {
            showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
            return;
        }

        try {
            showNotification('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...', 'info');
            const response = await fetch('/api/accounts/send-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone})
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                currentAuthPhone = phone;
                currentAuthCodeHash = result.code_hash;
                document.getElementById('codeGroup').style.display = 'block';
                document.getElementById('sendCodeBtn').style.display = 'none';
                document.getElementById('verifyCodeBtn').style.display = 'inline-flex';
                showNotification('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram', 'success');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', error);
        }
    }

    async function verifyAuthCode() {
        const code = document.getElementById('addCode').value.trim();
        if (!code) {
            showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥', 'error');
            return;
        }

        try {
            showNotification('‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'info');
            const response = await fetch('/api/accounts/verify-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone: currentAuthPhone,
                    code: code,
                    code_hash: currentAuthCodeHash
                })
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                if (result.requires_2fa) {
                    // –ù—É–∂–µ–Ω 2FA –ø–∞—Ä–æ–ª—å
                    document.getElementById('password2FAGroup').style.display = 'block';
                    document.getElementById('verifyCodeBtn').style.display = 'none';
                    document.getElementById('verify2FABtn').style.display = 'inline-flex';
                    showNotification('üîê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA', 'info');
                } else {
                    // –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    showAccountSettings();
                }
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:', error);
        }
    }

    async function verify2FA() {
        const password = document.getElementById('addPassword2FA').value.trim();
        if (!password) {
            showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA', 'error');
            return;
        }

        try {
            showNotification('‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è 2FA...', 'info');
            const response = await fetch('/api/accounts/verify-2fa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone: currentAuthPhone,
                    password: password,
                    code_hash: currentAuthCodeHash
                })
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                showAccountSettings();
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ 2FA:', error);
        }
    }

    function showAccountSettings() {
        document.getElementById('accountSettingsGroup').style.display = 'block';
        document.getElementById('accountDestGroup').style.display = 'block';
        document.getElementById('accountGenderGroup').style.display = 'block';
        document.getElementById('verifyCodeBtn').style.display = 'none';
        document.getElementById('verify2FABtn').style.display = 'none';
        document.getElementById('saveAccountBtn').style.display = 'inline-flex';
        showNotification('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 'success');
    }

    async function saveNewAccount() {
        const data = {
            phone: currentAuthPhone,
            source_chat: document.getElementById('addSource').value.trim(),
            dest_chats: document.getElementById('addDest').value.split(',').map(s => s.trim()).filter(s => s),
            gender: document.getElementById('addGender').value
        };

        try {
            const response = await fetch('/api/accounts/save-settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                showNotification('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                closeAddAccountModal();
                loadAccounts();
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    function handleSessionFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.name.endsWith('.session')) {
            document.getElementById('selectedSessionFileName').textContent = `–í—ã–±—Ä–∞–Ω: ${file.name}`;
            document.getElementById('sessionSettingsGroup').style.display = 'block';
            document.getElementById('sessionDestGroup').style.display = 'block';
            document.getElementById('sessionGenderGroup').style.display = 'block';
        } else {
            showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ .session —Ñ–∞–π–ª', 'error');
        }
    }

    async function uploadSessionFile() {
        const fileInput = document.getElementById('sessionFileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ .session —Ñ–∞–π–ª', 'error');
            return;
        }

        try {
            showNotification('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ .session —Ñ–∞–π–ª–∞...', 'info');
            const formData = new FormData();
            formData.append('session_file', file);
            formData.append('source_chat', document.getElementById('sessionSource').value.trim());
            formData.append('dest_chats', document.getElementById('sessionDest').value);
            formData.append('gender', document.getElementById('sessionGender').value);

            const response = await fetch('/api/accounts/upload-session', {
                method: 'POST',
                body: formData
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (response.status === 401 || response.status === 403) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ.', 'error');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', 'error');
                }
                console.error('–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω:', text.substring(0, 100));
                return;
            }

            const result = await response.json();
            if (result.success) {
                showNotification('‚úÖ .session —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
                closeAddAccountModal();
                loadAccounts();
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    function closeAddAccountModal() {
        document.getElementById('addAccountModal').style.display = 'none';
        currentAuthStep = 1;
        currentAuthPhone = null;
        currentAuthCodeHash = null;
    }

    function showBulkActions() {
        const selected = Array.from(document.querySelectorAll('.account-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π', 'info');
            return;
        }
        alert(`–ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è ${selected.length} –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)`);
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function closeAddAccountModal() {
        closeModal('addAccountModal');
    }

    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    loadAccounts();
</script>
{% endblock %}
